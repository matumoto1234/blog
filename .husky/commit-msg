#!/usr/bin/env sh

. "$(dirname -- "$0")/_/husky.sh"

echo -e "\033[37;1mğŸª Running Git Hooks: commit-msg\033[0m\n"

# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å®šç¾©
readonly commit_msg="$(cat "$1")"

# çµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’å®šç¾©ã€‚0: OK, 1: NG
exit_code=0

# Prefixã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
## å¿…è¦ãªPrefixã‚’å®šç¾©
correct_prefixes=("feat" "fix" "docs" "style" "refactor" "pref" "test" "chore")

## å„è¦ç´ ã«": "ã‚’è¿½åŠ 
for i in "${!correct_prefixes[@]}"; do
  correct_prefixes[i]="${correct_prefixes[i]}: "
done

## `grep -E`ã§é…åˆ—ã‹ã‚‰ORæ¤œç´¢ã‚’ã™ã‚‹ãŸã‚ã€åŠè§’ã‚¹ãƒšãƒ¼ã‚¹(" ")ã®åŒºåˆ‡ã‚Šæ–‡å­—ã‚’ãƒ‘ã‚¤ãƒ—("|")ã«å¤‰æ›´
prefixes="$(
  IFS="|"
  echo "${correct_prefixes[*]}"
)"

if echo "$commit_msg" | grep -E --no-message "${prefixes}" > /dev/null; then
  echo -e "âœ…\033[32;22mOK\033[0m : Prefixã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯\n"
else
  echo -e "\033[31;22mâš ï¸NG\033[0m : Prefixã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯:"
  echo -e "  ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«PrefixãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“"
  echo -e "  Allowed prefix:"
  echo -e "    ${correct_prefixes[*]}\n"
  exit_code=1
fi

# issueç•ªå·ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
if echo "$commit_msg" | grep --no-message "#[1-9]" > /dev/null; then
  echo -e "âœ…\033[32;22mOK\033[0m : issueç•ªå·ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯\n"
else
  echo -e "\033[31;22mâš ï¸NG\033[0m : issueç•ªå·ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯:"
  echo -e "  ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«issueç•ªå·ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“"
  echo -e "  Format: #[issue_number]"
  echo -e "  Example: #1234\n"
  exit_code=1
fi

exit ${exit_code}
